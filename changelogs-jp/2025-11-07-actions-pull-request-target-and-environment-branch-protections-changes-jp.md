---
title: "Actions の pull_request_target と環境ブランチ保護の変更"
date: "2025-11-07"
type: "improvements"
labels: ["actions"]
author: "Allison"
source_url: "https://github.blog/changelog/2025-11-07-actions-pull_request_target-and-environment-branch-protections-changes"
fetched_at: "2026-02-03T14:50:55.373097Z"
lang: "ja"
---

# Actions の pull_request_target と環境ブランチ保護の変更

## Overview
GitHub は、GitHub Actions の pull_request_target と環境ブランチ保護ルールがプルリクエスト関連イベントで評価される方法を更新しています。

## Detailed Explanation
### 概要
- GitHub は、GitHub Actions の pull_request_target と環境ブランチ保護ルールがプルリクエスト関連イベントで評価される方法を更新しています。
- これらの変更は 2025年12月8日に発効します。この変更は、ユーザー制御のブランチでこれらのイベントがどのように動作するかに関するセキュリティ上重要なエッジケースを減らすことを目的としており、ユーザー提供のワークフローコードの予期しない実行や環境シークレットでの実行を防ぎます。

### 何が変わるのか？
- pull_request_target イベントは、ワークフローソースと参照に常にデフォルトブランチを使用するようになります:
- ワークフローファイルとチェックアウトコミットは、プルリクエストのベースブランチに関係なく、常にリポジトリのデフォルトブランチから取得されます。これにより、リポジトリ内の他のブランチにある古い、潜在的に脆弱なワークフローがこれらのイベントで実行されることを防ぎます。
- pull_request_target の GITHUB_REF はデフォルトブランチに解決され、GITHUB_SHA はそのブランチの最新コミットを指します。これにより、ref のセマンティクスがセキュリティモデルと整合し、信頼できない名前やブランチが評価に影響を与える可能性がある既知のクラスの脆弱性を閉じます。
- 以前は、プルリクエストのベースブランチとして設定された親リポジトリ内の任意のブランチが、実行されるワークフローのソース ( GITHUB_REF / GITHUB_SHA ) として使用され、古いワークフローの実行につながる可能性がありました。歴史的に、この動作は、デフォルトブランチで修正されたために修正されたと想定されていた pull_request_target ワークフローに脆弱性が含まれていた古いワークフローの悪用につながっていました。この変更により、リポジトリのデフォルトブランチのみがこれらのイベントで実行されるワークフローソースとして使用できるようになり、pull_request_target ワークフローの脆弱性の修正が開発者の脆弱性修正に関する期待により良く整合し、リポジトリ内のすべての古いブランチを更新する必要がなくなります。
- この変更により、リポジトリ内の pull_request_target ワークフローの脆弱性の修正が可能になりますが、フォークからのプルリクエストと組み合わせた pull_request_target イベントの使用にはリスクが増加することに注意することが重要です。pull_request_target イベントは、外部フォークから送信される可能性のあるユーザー提供のプルリクエストに基づいて実行され、アクションシークレットにアクセスして実行されます。この攻撃面を考慮すると、アクションワークフローの脆弱性を回避し、信頼できないコードや入力が実行に影響を与える方法で使用されていないことを確認するように注意する必要があります。GitHub のコードスキャニングと CodeQL を使用して、アクションワークフローの脆弱性を特定でき、すべてのパブリックリポジトリで無料です。
- もう1つの変更は、プルリクエストイベントの環境ブランチ保護ルールが実行参照に対して評価されることです:
- プルリクエストワークフロー中の環境シークレットへの意図しないアクセスを防ぐため、環境ブランチ保護ルールは、プルリクエストヘッド ( HEAD_REF ) ではなく、実行参照 ( GITHUB_REF ) に対して評価されます。
- pull_request 、 pull_request_review 、および pull_request_review_comment の場合、環境ルールは refs/pull/number/merge に対して評価されます。これは、これらのイベントが実行中に使用するマージコミットコンテキストと一致します。
- pull_request_target の場合、環境ルールはデフォルトブランチに対して評価されます。これは更新された GITHUB_REF と一致し、ポリシーチェックが信頼できる ref に対して行われることを保証します。

### 破壊的変更と影響
- プルリクエストトリガーを持つ環境ブランチ保護ルールに依存するワークフローは、pull_request ファミリーイベントの評価が refs/pull/number/merge で行われ、pull_request_target の評価がデフォルトブランチで行われるようになったため、以前のブランチパターンと一致しなくなる可能性があります。それに応じて環境ブランチフィルターを更新してください。

### あなたがすべきこと
- pull_request_target の使用を評価し、必要な場合にのみ使用してください:
- ユーザー制御の入力やコードが、信頼できないコードを実行する方法で実行に影響を与えることができないことを確認してください。
- ワークフローが昇格された権限やシークレットへのアクセスを必要としない場合は、代わりに pull_request を使用してください。
- これらのワークフローに付与される権限を制限してください。デフォルトトークンの権限を読み取り専用に設定するか、ワークフローで最小権限設定を適用してください。
- コードスキャニングを有効にして、CodeQL にアクションワークフローの一般的な脆弱性をスキャンさせてください。
- ワークフローがブランチ保護ルールを持つ環境を使用し、プルリクエストイベントによってトリガーされる場合:
- pull_request の環境ブランチフィルターを更新し、 refs/pull/number/merge のようなパターンを追加してください。 pull_request_target の場合は、リポジトリのデフォルトブランチを追加してください。
- 既存のブランチ保護ルールを引き続き使用するために代替のワークフロートリガーを検討するか、既存のワークフロートリガーを引き続き使用するために代替のブランチ保護ルールを検討してください。
- 最後の手段として、プルリクエストジョブで使用される環境ブランチ保護ルールを無効にすることを検討してください。ただし、シークレット露出リスクのトレードオフを認識してください。

### フィードバックの提供方法
- フィードバックや質問がある場合は、コミュニティディスカッションにコメントを残してください。

## Key Changes
- プルリクエストトリガーを持つ環境ブランチ保護ルールに依存するワークフローは、pull_request ファミリーイベントの評価が refs/pull/number/merge で行われ、pull_request_target の評価がデフォルトブランチで行われるようになったため、以前のブランチパターンと一致しなくなる可能性があります。それに応じて環境ブランチフィルターを更新してください。

## Impact / Who's Affected
- この変更により、リポジトリのデフォルトブランチのみがこれらのイベントで実行されるワークフローソースとして使用できるようになり、pull_request_target ワークフローの脆弱性の修正が開発者の脆弱性修正に関する期待により良く整合し、リポジトリ内のすべての古いブランチを更新する必要がなくなります。
- あなたがすべきこと pull_request_target の使用を評価し、必要な場合にのみ使用してください: ユーザー制御の入力やコードが、信頼できないコードを実行する方法で実行に影響を与えることができないことを確認してください。
- デフォルトトークンの権限を読み取り専用に設定するか、ワークフローで最小権限設定を適用してください。

## Caveats / Limitations
- この変更により、リポジトリのデフォルトブランチのみがこれらのイベントで実行されるワークフローソースとして使用できるようになり、pull_request_target ワークフローの脆弱性の修正が開発者の脆弱性修正に関する期待により良く整合し、リポジトリ内のすべての古いブランチを更新する必要がなくなります。
- この変更により、リポジトリ内の pull_request_target ワークフローの脆弱性の修正が可能になりますが、フォークからのプルリクエストと組み合わせた pull_request_target イベントの使用にはリスクが増加することに注意することが重要です。pull_request_target イベントは、外部フォークから送信される可能性のあるユーザー提供のプルリクエストに基づいて実行され、アクションシークレットにアクセスして実行されます。
- あなたがすべきこと pull_request_target の使用を評価し、必要な場合にのみ使用してください: ユーザー制御の入力やコードが、信頼できないコードを実行する方法で実行に影響を与えることができないことを確認してください。
- デフォルトトークンの権限を読み取り専用に設定するか、ワークフローで最小権限設定を適用してください。

## Insights (derived from article language)
- この変更により、リポジトリ内の pull_request_target ワークフローの脆弱性の修正が可能になりますが、フォークからのプルリクエストと組み合わせた pull_request_target イベントの使用にはリスクが増加することに注意することが重要です。pull_request_target イベントは、外部フォークから送信される可能性のあるユーザー提供のプルリクエストに基づいて実行され、アクションシークレットにアクセスして実行されます。
- あなたがすべきこと pull_request_target の使用を評価し、必要な場合にのみ使用してください: ユーザー制御の入力やコードが、信頼できないコードを実行する方法で実行に影響を与えることができないことを確認してください。
- 既存のブランチ保護ルールを引き続き使用するために代替のワークフロートリガーを検討するか、既存のワークフロートリガーを引き続き使用するために代替のブランチ保護ルールを検討してください。

## Article Content (cleaned)
GitHub は、GitHub Actions の `pull_request_target` と環境ブランチ保護ルールがプルリクエスト関連イベントで評価される方法を更新しています。


これらの変更は 2025年12月8日に発効します。この変更は、ユーザー制御のブランチでこれらのイベントがどのように動作するかに関するセキュリティ上重要なエッジケースを減らすことを目的としており、ユーザー提供のワークフローコードの予期しない実行や環境シークレットでの実行を防ぎます。


### [何が変わるのか？](#what-is-changing)


`pull_request_target` イベントは、ワークフローソースと参照に常にデフォルトブランチを使用するようになります:


* ワークフローファイルとチェックアウトコミットは、プルリクエストのベースブランチに関係なく、常にリポジトリのデフォルトブランチから取得されます。これにより、リポジトリ内の他のブランチにある古い、潜在的に脆弱なワークフローがこれらのイベントで実行されることを防ぎます。
* `pull_request_target` の `GITHUB_REF` はデフォルトブランチに解決され、`GITHUB_SHA` はそのブランチの最新コミットを指します。これにより、ref のセマンティクスがセキュリティモデルと整合し、信頼できない名前やブランチが評価に影響を与える可能性がある既知のクラスの脆弱性を閉じます。


以前は、プルリクエストのベースブランチとして設定された親リポジトリ内の任意のブランチが、実行されるワークフローのソース (`GITHUB_REF`/`GITHUB_SHA`) として使用され、古いワークフローの実行につながる可能性がありました。歴史的に、この動作は、デフォルトブランチで修正されたために修正されたと想定されていた `pull_request_target` ワークフローに脆弱性が含まれていた古いワークフローの悪用につながっていました。この変更により、リポジトリのデフォルトブランチのみがこれらのイベントで実行されるワークフローソースとして使用できるようになり、`pull_request_target` ワークフローの脆弱性の修正が開発者の脆弱性修正に関する期待により良く整合し、リポジトリ内のすべての古いブランチを更新する必要がなくなります。


この変更により、リポジトリ内の `pull_request_target` ワークフローの脆弱性の修正が可能になりますが、フォークからのプルリクエストと組み合わせた `pull_request_target` イベントの使用にはリスクが増加することに注意することが重要です。`pull_request_target` イベントは、外部フォークから送信される可能性のあるユーザー提供のプルリクエストに基づいて実行され、アクションシークレットにアクセスして実行されます。この攻撃面を考慮すると、[アクションワークフローの脆弱性](https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/)を回避し、信頼できないコードや入力が実行に影響を与える方法で使用されていないことを確認するように注意する必要があります。GitHub のコードスキャニングと CodeQL を使用して、[アクションワークフローの脆弱性を特定](https://github.blog/changelog/2025-04-22-github-actions-workflow-security-analysis-with-codeql-is-now-generally-available/)でき、すべてのパブリックリポジトリで無料です。


もう1つの変更は、プルリクエストイベントの環境ブランチ保護ルールが実行参照に対して評価されることです:


* プルリクエストワークフロー中の環境シークレットへの意図しないアクセスを防ぐため、環境ブランチ保護ルールは、プルリクエストヘッド (`HEAD_REF`) ではなく、実行参照 (`GITHUB_REF`) に対して評価されます。
* `pull_request`、`pull_request_review`、および `pull_request_review_comment` の場合、環境ルールは `refs/pull/number/merge` に対して評価されます。これは、これらのイベントが実行中に使用するマージコミットコンテキストと一致します。
* `pull_request_target` の場合、環境ルールはデフォルトブランチに対して評価されます。これは更新された `GITHUB_REF` と一致し、ポリシーチェックが信頼できる ref に対して行われることを保証します。


### [破壊的変更と影響](#breaking-changes-and-impact)


プルリクエストトリガーを持つ環境ブランチ保護ルールに依存するワークフローは、`pull_request` ファミリーイベントの評価が `refs/pull/number/merge` で行われ、`pull_request_target` の評価がデフォルトブランチで行われるようになったため、以前のブランチパターンと一致しなくなる可能性があります。それに応じて環境ブランチフィルターを更新してください。


### [あなたがすべきこと](#what-you-should-do)


`pull_request_target` の使用を評価し、必要な場合にのみ使用してください:


* ユーザー制御の入力やコードが、信頼できないコードを実行する方法で実行に影響を与えることができないことを確認してください。
* ワークフローが昇格された権限やシークレットへのアクセスを必要としない場合は、代わりに `pull_request` を使用してください。
* これらのワークフローに付与される権限を制限してください。デフォルトトークンの[権限](https://docs.github.com/actions/security-guides/automatic-token-authentication#modifying-the-permissions-for-the-github_token.)を読み取り専用に設定するか、ワークフローで最小権限設定を適用してください。
* コードスキャニングを有効にして、[CodeQL](https://docs.github.com/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/about-code-scanning) にアクションワークフローの一般的な脆弱性をスキャンさせてください。


ワークフローがブランチ保護ルールを持つ環境を使用し、プルリクエストイベントによってトリガーされる場合:


* `pull_request` の環境ブランチフィルターを更新し、`refs/pull/number/merge` のようなパターンを追加してください。`pull_request_target` の場合は、リポジトリのデフォルトブランチを追加してください。
* 既存のブランチ保護ルールを引き続き使用するために代替のワークフロートリガーを検討するか、既存のワークフロートリガーを引き続き使用するために代替のブランチ保護ルールを検討してください。
* 最後の手段として、プルリクエストジョブで使用される環境ブランチ保護ルールを無効にすることを検討してください。ただし、シークレット露出リスクのトレードオフを認識してください。


### [フィードバックの提供方法](#how-to-give-feedback)


フィードバックや質問がある場合は、[コミュニティディスカッション](https://github.com/orgs/community/discussions/179107)にコメントを残してください。
